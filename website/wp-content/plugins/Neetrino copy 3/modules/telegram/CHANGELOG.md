# Исправления Telegram модуля

## Проблемы которые были исправлены:

### 1. ❌ Дублирование уведомлений (8 раз один заказ)
**Причина:** Модуль инициализировался несколько раз и хуки добавлялись повторно
**Решение:** 
- Добавлена защита от повторной инициализации хуков
- Добавлены транзиенты для предотвращения отправки дублирующихся уведомлений
- Каждое уведомление блокируется на 5 минут после отправки

### 2. ❌ Неправильное время заказа (12:04 вместо реального времени)
**Причина:** Время отображалось в UTC вместо часового пояса WordPress
**Решение:** 
- Исправлено использование часового пояса WordPress `wp_timezone()`
- Время теперь показывается корректно для вашего региона

## Что добавлено:

1. **Логирование** - теперь все действия записываются в лог для отладки
2. **Автоматическая очистка** - старые транзиенты очищаются ежедневно
3. **Защита от повторов** - несколько уровней защиты от дублирования
4. **Улучшенная обработка ошибок**

## Что делать после обновления:

1. **Запустите очистку** (только один раз):
   - Откройте в браузере: `ваш-сайт.com/wp-content/plugins/Neetrino/modules/telegram/debug-cleanup.php`
   - Это очистит все старые дублирующиеся уведомления
   - После использования удалите файл `debug-cleanup.php` для безопасности

2. **Проверьте работу:**
   - Создайте тестовый заказ
   - Убедитесь что приходит только одно уведомление
   - Проверьте что время показывается правильно

3. **Мониторинг:**
   - Включите WordPress логи (`define('WP_DEBUG_LOG', true);` в wp-config.php)
   - Проверяйте файл `wp-content/debug.log` на наличие записей "Telegram:"

## Если проблемы повторяются:

1. Проверьте логи в `wp-content/debug.log`
2. Убедитесь что модуль активен только в одном месте
3. Свяжитесь с разработчиком, приложив логи

## Технические детали:

- Добавлены транзиенты с префиксом `telegram_order_notification_` и `telegram_status_notification_`
- Время блокировки повторных уведомлений: 5 минут
- Автоматическая очистка старых транзиентов: ежедневно
- Дополнительная защита с помощью `has_action()` проверок
