<?php
/**
 * Telegram Debug Cleanup Utility
 * –≠—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ–º–æ–∂–µ—Ç –æ—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥—É–±–ª–∏—Ä—É—é—â–∏–µ—Å—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
 * –ó–∞–ø—É—Å—Ç–∏—Ç–µ –µ–≥–æ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä –æ–¥–∏–Ω —Ä–∞–∑, –µ—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ —Å –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ–º –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
 */

// –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ WordPress –∞–¥–º–∏–Ω
if (!defined('ABSPATH')) {
    // –ï—Å–ª–∏ —Ñ–∞–π–ª –≤—ã–∑–≤–∞–Ω –Ω–∞–ø—Ä—è–º—É—é, –ø–æ–¥–∫–ª—é—á–∞–µ–º WordPress
    require_once('../../../../../wp-config.php');
}

if (!is_admin() && !current_user_can('manage_options')) {
    wp_die('–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —ç—Ç–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è.');
}

// –£–±–µ–∂–¥–∞–µ–º—Å—è —á—Ç–æ –º–æ–¥—É–ª—å –∑–∞–≥—Ä—É–∂–µ–Ω
if (class_exists('Telegram')) {
    echo "<h1>Telegram Module Cleanup</h1>";
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
    $cleaned = Telegram::force_cleanup_notifications();
    echo "<p>‚úÖ –û—á–∏—â–µ–Ω–æ —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–æ–≤ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π: <strong>$cleaned</strong></p>";
    
    // –û—á–∏—â–∞–µ–º –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è
    $cleared_events = 0;
    while (wp_next_scheduled('telegram_cleanup_old_transients')) {
        wp_clear_scheduled_hook('telegram_cleanup_old_transients');
        $cleared_events++;
    }
    echo "<p>‚úÖ –û—á–∏—â–µ–Ω–æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π: <strong>$cleared_events</strong></p>";
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    global $wpdb;
    $remaining = $wpdb->get_var(
        "SELECT COUNT(*) FROM {$wpdb->options} 
         WHERE option_name LIKE '_transient%telegram_%'"
    );
    echo "<p>üìä –û—Å—Ç–∞–ª–æ—Å—å telegram —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–æ–≤: <strong>$remaining</strong></p>";
    
    echo "<hr>";
    echo "<p><strong>–ß—Ç–æ –±—ã–ª–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:</strong></p>";
    echo "<ul>";
    echo "<li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∑–∞—â–∏—Ç–∞ –æ—Ç –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —Ö—É–∫–æ–≤</li>";
    echo "<li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–æ–≤ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è</li>";
    echo "<li>‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –∑–∞–∫–∞–∑–∞ (—Ç–µ–ø–µ—Ä—å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è —á–∞—Å–æ–≤–æ–π –ø–æ—è—Å WordPress)</li>";
    echo "<li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏</li>";
    echo "<li>‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ç—Ä–∞–Ω–∑–∏–µ–Ω—Ç–æ–≤</li>";
    echo "</ul>";
    
    echo "<p><strong>–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:</strong></p>";
    echo "<ul>";
    echo "<li>–£–¥–∞–ª–∏—Ç–µ —ç—Ç–æ—Ç —Ñ–∞–π–ª –ø–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏</li>";
    echo "<li>–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ WordPress (wp-content/debug.log) –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ä–∞–±–æ—Ç—ã —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</li>";
    echo "<li>–ï—Å–ª–∏ –ø—Ä–æ–±–ª–µ–º–∞ –ø–æ–≤—Ç–æ—Ä–∏—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ –º–æ–¥—É–ª—å –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –Ω–µ—Å–∫–æ–ª—å–∫–æ —Ä–∞–∑</li>";
    echo "</ul>";
    
} else {
    echo "<h1>‚ùå –û—à–∏–±–∫–∞</h1>";
    echo "<p>–ú–æ–¥—É–ª—å Telegram –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.</p>";
}

// –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–∑–≤—Ä–∞—Ç–∞ –≤ –∞–¥–º–∏–Ω–∫—É
echo '<p><a href="' . admin_url() . '" class="button button-primary">‚Üê –í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –∞–¥–º–∏–Ω–∫—É</a></p>';
?>
