# План: Версионный контроль плагина + Централизованный планировщик интервалов (Dashboard)

Документ фиксирует архитектуру, правила и пошаговое внедрение:
- Единый алгоритм проверки версии плагина (смешанный push + pull) и безопасное поведение при несовпадении версии.
- Централизованный планировщик (Scheduler) на дашборде с пер‑задачными интервалами (сек/мин/ч/дни), управлением, логами и метриками.
- Интеграция с существующими авто/ручными проверками.

## Цели
- Безопасность: ни один запрос с дашборда не выполняется на сайте с версией плагина ниже минимально требуемой.
- Единообразие: все исходящие запросы проходят через один диспетчер и одну политику версий.
- Управляемость: админ может настраивать интервалы для 10–20+ фоновых процессов отдельно, с гибкими единицами времени.
- Масштаб: корректная работа на 100–1000 сайтов с контролем нагрузки (rate limit, jitter, батчи).

## Термины
- Dashboard — центральная панель, инициирует запросы/проверки.
- Плагин — код на стороне сайта, принимает команды, имеет константу VERSION.
- MinRequired — минимальная версия плагина, требуемая для конкретной операции.
- Scheduler — планировщик задач на дашборде.

---

## 1) Единый алгоритм проверки версии (push + pull)

- Push (быстрая актуализация)
  - При установке/активации/обновлении плагин отправляет на дашборд: siteId, pluginVersion, timestamp, nonce, подпись.
  - Дашборд валидирует и обновляет кэш версии для сайта.

- Pull (самовосстановление)
  - Периодически дашборд опрашивает сайт (endpoint `/health` или `/meta`) и читает актуальную VERSION.
  - Ответ проверяется (подпись/секрет). При успехе — кэш обновляется.

- Перед любым действием с дашборда
  - Диспетчер исходящих запросов читает кэш `plugin_version` для сайта.
  - Если `plugin_version < MinRequired` — действие блокируется на дашборде заранее (UX: сообщение "требуется обновление плагина"). Запрос не отправляется.
  - Если всё ок — запрос отправляется с заголовками/подписью и полем `X-Min-Plugin-Version`.

- На стороне плагина (защита на границе)
  - SecurityGate: верификация подписи, timestamp, nonce (anti‑replay).
  - VersionGate: `version_compare(VERSION, X-Min-Plugin-Version, '>=')`. Если ниже — `HTTP 426 Upgrade Required` + безопасный fallback (без изменения состояния), лог.

- Поведение при несовпадении версий
  - Dashboard: блокирует действие и предлагает обновить плагин.
  - Плагин: не выполняет, безопасно отвечает 426, пишет лог.

Минимальный контракт (сводно)
- Заголовки/claims: SiteId, Timestamp, Nonce, X-Min-Plugin-Version, Signature (HMAC-SHA256 или JWT HS256).
- Допуски времени: ±300 сек, Nonce TTL 10 минут, повтор Nonce запрещён.

---

## 2) Централизованный планировщик (Scheduler)

### 2.1 Задачи (примеры)
- Health-check сайта (проверка доступности и состояния).
- Meta/Version refresh (подтверждение версии плагина).
- Диагностика/аудит (лёгкая/тяжёлая — разнести по задачам).
- Очистки/техпроцессы.
- Уведомления (например, Telegram), webhooks и т.п.

### 2.2 Интервалы и единицы времени
- Для каждой задачи настраивается интервал в единицах: секунды, минуты, часы, дни.
- Поддержка CRON‑подобного режима (дополнительно, позже) — как расширение.
- Глобальные дефолты:
  - Health-check: 3–5 минут по умолчанию (с джиттером). 30 секунд — только для отладки.
  - Meta/Version refresh: 5–15 минут.
- Jitter: 10–20% случайный сдвиг, чтобы избегать «шторма» одновременных запросов.

### 2.3 Хранение в БД (предложение схемы)
- Таблица `scheduled_tasks`
  - id (pk), key (уникальный идентификатор задачи, например `health_check`, `version_refresh`),
  - enabled (bool),
  - interval_value (int), interval_unit (enum: second|minute|hour|day),
  - jitter_percent (int, 0–30),
  - max_concurrency (int, nullable),
  - last_run_at (datetime), next_run_at (datetime),
  - retry_policy (json: max_attempts, backoff_strategy, base_delay_ms),
  - updated_at, created_at.

- Таблица `task_runs`
  - id (pk), task_key, site_id (nullable — если задача глобальная),
  - started_at, finished_at, status (ok|fail|skipped|rate_limited),
  - attempts (int), error_code, error_message (text),
  - correlation_id (uuid), payload_snapshot (json),
  - created_at.

- Таблица `site_versions`
  - site_id (pk/unique), plugin_version (varchar), last_seen_at (datetime),
  - source (enum: push|pull), signature_ok (bool),
  - version_ttl_min (int, дефолт 15), updated_at.

- Таблица `request_nonces`
  - jti/nonce (pk), site_id, created_at, expires_at.

Примечание: имена/типы уточним под используемую СУБД и текущие таблицы.

### 2.4 Исполнитель (runner)
- Один системный процесс (или cron/задача планировщика ОС) регулярно вызывает runner.
- Runner выбирает due‑задачи по `next_run_at <= now()` и статусу `enabled = 1`.
- Для задач, «персайтовых», формирует очереди по батчам: N сайтов за тик.
- Ставит `last_run_at` и вычисляет новый `next_run_at` с учётом jitter и retry.
- Соблюдает `max_concurrency` (глобально и/или per task).
- Записывает `task_runs` с результатом.

### 2.5 Отказоустойчивость и нагрузка
- Retry с backoff: линейный/экспоненциальный (конфигурируемо в `retry_policy`).
- Rate limiting per host (например, не более X запросов к одному сайту в минуту).
- Батчи: обрабатывать сайты пачками (например, по 20–50) с задержкой между пачками.
- Таймауты: разумные (например, 10–20 сек) с отменой долгих «висящих» вызовов.

### 2.6 Метрики и логи
- Счётчики: всего запусков, успешных, 426 ответов, ошибок подписи, таймаутов.
- Время выполнения задач (p50/p95), средний размер батча.
- Последний успешный run per site per task.

---

## 3) UI/UX: вкладка «Интервалы и задачи»

Список задач (таблица):
- Колонки: Название, Ключ, Включена, Интервал (значение + единица), Jitter, Max concurrency, Последний запуск, Следующий запуск, Последний статус, Действия.
- Действия:
  - Изменить интервал (модал):
    - Поля: значение, единица (сек/мин/ч/дни), jitter (%), max concurrency, retry policy.
    - Валидации: минимумы/максимумы, предупреждения о нагрузке.
  - Включить/Выключить задачу.
  - «Запустить сейчас» (ручной триггер с ограничениями частоты).
  - Просмотр логов/истории запусков.

Глобальные настройки:
- «Интервал по умолчанию для новых задач» (значение + единицы).
- Лимиты нагрузки (rate limits), таймауты по умолчанию.

Важно про текущую настройку интервала (что уже есть сейчас):
- Текущая настройка в админке отвечает за частоту текущего health‑check.
- В новой системе она станет «дефолтом» для задачи `health_check` и/или глобальным дефолтом для новых задач.
- Для остальных задач будут свои отдельные интервалы, управляемые в этой вкладке.
- Переход — мягкий: сохраните текущую настройку как initial‑значение для соответствующей задачи.

---

## 4) Интеграция с авто/ручными проверками
- Автоматическая проверка
  - При каждом health/meta запросе, если `site_versions.last_seen_at` старше TTL (например, > 15 мин) или `plugin_version` отличается — обновить запись.
  - Обновлять метрики/логи.

- Ручная проверка
  - При ручном запуске «Проверить сайт сейчас» делаем тот же health/meta и обновляем кэш версии, если устарел.
  - Показываем в UI время и результат последнего обновления версии.

---

## 5) Масштабирование до 1000 сайтов
- Staggering: разнесение запусков задач по времени с помощью jitter и случайной фазы.
- Батчи: «N сайтов за тик» вместо «все сразу»; параметры N конфигурируемы.
- Параллелизм с лимитами: максимум K одновременных запросов, очередь для остальных.
- Кэш DNS/keep‑alive/пайплайнинг HTTP‑клиента для уменьшения накладных расходов.
- Обработка «плохих» сайтов с backoff и карантином (временно снижать частоту).

---

## 6) Пошаговый план внедрения
1. Документ (этот файл) согласовать.
2. Дашборд: добавить таблицы `scheduled_tasks`, `task_runs`, `site_versions` (миграции).
3. Реализовать диспетчер исходящих запросов (подпись, X-Min-Plugin-Version, timestamp/nonce).
4. Реализовать Scheduler Runner (один входной скрипт/контроллер + сервис):
   - Регистрация задач: `health_check`, `version_refresh`.
   - Интервалы и UI минимально: список + «Изменить интервал».
5. Плагин: внедрить SecurityGate + VersionGate (единая точка входа для API).
6. Включить push при установке/активации/обновлении плагина (с подписью).
7. Перевести существующий health‑check на Scheduler, задать дефолтные интервалы.
8. Нагрузочное испытание на 100–200 сайтах с батчами и лимитами; корректировка интервалов.
9. Расширение: новые задачи (диагностика, уведомления и т.п.), CRON‑режим по необходимости.

---

## 7) Риски и смягчение
- Устаревший кэш версии — push+pull вместе, TTL и ручное обновление из UI.
- Подмена ответов — везде обязательная подпись и проверка таймстампа/nonce.
- Шторм запросов — jitter, батчи, rate limiting, max concurrency.
- Долгие или зависающие сайты — таймауты, backoff, карантин.

---

## 8) Примечания по окружению
- Текущая настройка интервала: использовать как дефолт для задачи `health_check` при миграции.
- Запуск планировщика: системная задача ОС/cron или внутренний таймер (по возможностям хостинга). Для Windows/локальной разработки — Планировщик заданий Windows или периодический web‑hook.

---

## 9) Следующие шаги
- Утвердить: состав таблиц и поля, список стартовых задач, дефолтные интервалы.
- После утверждения — подготовить миграции БД, каркас Scheduler и UI «Интервалы и задачи».
