// Prisma Schema для Neetrino Dashboard
// PostgreSQL (Neon, Supabase и т.д.)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==========================================
// Администраторы системы
// ==========================================
model AdminUser {
  id              Int       @id @default(autoincrement())
  username        String    @unique @db.VarChar(50)
  email           String    @unique @db.VarChar(100)
  passwordHash    String    @map("password_hash") @db.VarChar(255)
  failedAttempts  Int       @default(0) @map("failed_attempts")
  lockedUntil     DateTime? @map("locked_until")
  lastLogin       DateTime? @map("last_login")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")
  isActive        Boolean   @default(true) @map("is_active")
  role            Role      @default(admin)

  deletedSites    Trash[]   @relation("DeletedBy")

  @@index([username])
  @@index([email])
  @@map("admin_users")
}

enum Role {
  admin
  moderator
}

// ==========================================
// Управляемые сайты
// ==========================================
model Site {
  id            Int          @id @default(autoincrement())
  siteUrl       String       @map("site_url") @db.VarChar(255)
  siteName      String       @map("site_name") @db.VarChar(100)
  adminEmail    String       @default("") @map("admin_email") @db.VarChar(100)
  apiKey        String?      @unique @map("api_key") @db.VarChar(64)
  apiKeyHash    String?      @map("api_key_hash") @db.VarChar(255)
  dashboardIp   String?      @map("dashboard_ip") @db.VarChar(45)
  dateAdded     DateTime     @default(now()) @map("date_added")
  activeModules String?      @map("active_modules") @db.Text
  status        SiteStatus   @default(offline)
  createdAt     DateTime     @default(now()) @map("created_at")
  lastSeen      DateTime?    @map("last_seen")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  rateLimits    RateLimit[]
  securityLogs  SecurityLog[]
  siteVersion   SiteVersion?

  @@index([siteUrl], map: "idx_site_url")
  @@index([apiKey], map: "idx_api_key")
  @@index([status], map: "idx_status")
  @@index([createdAt], map: "idx_created_at")
  @@index([lastSeen], map: "idx_last_seen")
  @@map("sites")
}

enum SiteStatus {
  online
  offline
  suspended
  maintenance
}

// ==========================================
// Rate Limiting
// ==========================================
model RateLimit {
  id           Int       @id @default(autoincrement())
  ipAddress    String    @map("ip_address") @db.VarChar(45)
  siteId       Int?      @map("site_id")
  requestCount Int       @default(1) @map("request_count")
  lastRequest  DateTime  @default(now()) @map("last_request")
  blockedUntil DateTime? @map("blocked_until")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  site         Site?     @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([ipAddress], map: "idx_ip_address")
  @@index([siteId], map: "idx_site_id")
  @@index([lastRequest], map: "idx_last_request")
  @@index([blockedUntil], map: "idx_blocked_until")
  @@map("rate_limits")
}

// ==========================================
// Логи безопасности
// ==========================================
model SecurityLog {
  id         Int           @id @default(autoincrement())
  siteId     Int?          @map("site_id")
  ipAddress  String        @map("ip_address") @db.VarChar(45)
  eventType  EventType     @map("event_type")
  eventData  Json?         @map("event_data")
  success    Boolean       @default(false)
  timestamp  DateTime      @default(now())
  userAgent  String?       @map("user_agent") @db.Text

  site       Site?         @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@index([siteId])
  @@index([ipAddress])
  @@index([eventType])
  @@index([timestamp])
  @@index([success])
  @@map("security_logs")
}

enum EventType {
  login_attempt
  api_call
  rate_limit
  suspicious_activity
  admin_action
}

// ==========================================
// Корзина (удалённые сайты)
// ==========================================
model Trash {
  id               Int        @id @default(autoincrement())
  siteUrl          String     @map("site_url") @db.VarChar(255)
  siteName         String     @map("site_name") @db.VarChar(100)
  activeModules    String?    @map("active_modules") @db.Text
  originalSiteId   Int?       @map("original_site_id")
  deletedAt        DateTime   @default(now()) @map("deleted_at")
  deletedReason    String     @default("plugin_deleted") @map("deleted_reason") @db.VarChar(100)
  deletedByAdminId Int?       @map("deleted_by_admin_id")
  restoreData      Json?      @map("restore_data")

  deletedBy        AdminUser? @relation("DeletedBy", fields: [deletedByAdminId], references: [id], onDelete: SetNull)

  @@index([deletedAt], map: "idx_deleted_at")
  @@index([originalSiteId], map: "idx_original_site_id")
  @@index([deletedByAdminId], map: "idx_deleted_by_admin_id")
  @@map("trash")
}

// ==========================================
// Настройки системы
// ==========================================
model SystemSetting {
  id           Int         @id @default(autoincrement())
  settingKey   String      @unique @map("setting_key") @db.VarChar(100)
  settingValue String?     @map("setting_value") @db.Text
  settingType  SettingType @default(string) @map("setting_type")
  description  String?     @db.Text
  isPublic     Boolean     @default(false) @map("is_public")
  createdAt    DateTime    @default(now()) @map("created_at")
  updatedAt    DateTime    @updatedAt @map("updated_at")

  @@index([settingKey], map: "idx_setting_key")
  @@index([isPublic], map: "idx_is_public")
  @@map("system_settings")
}

enum SettingType {
  string
  integer
  boolean
  json
}

// ==========================================
// Версии плагинов на сайтах
// ==========================================
model SiteVersion {
  siteId        Int       @id @map("site_id")
  pluginVersion String    @map("plugin_version") @db.VarChar(50)
  lastSeenAt    DateTime  @map("last_seen_at")
  source        Source    @default(push)
  signatureOk   Boolean   @default(true) @map("signature_ok")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  site          Site      @relation(fields: [siteId], references: [id], onDelete: Cascade)

  @@map("site_versions")
}

enum Source {
  push
  pull
}
